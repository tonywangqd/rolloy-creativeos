# Prompt 版本管理系统 - 需求文档 (PRD)

## 1. 背景与目标

### 1.1 问题陈述
当前创意工作台（Creative Workbench）存在以下问题：
- 用户每次使用"AI Prompt 微调"功能时，旧版本的 Prompt 会被覆盖
- 用户无法回退到之前的 Prompt 版本
- 生成的图片无法追溯是由哪个版本的 Prompt 生成的
- 用户无法对比不同版本 Prompt 生成的图片质量

### 1.2 目标
建立一个完整的 Prompt 版本管理系统，使得：
1. 每次微调自动创建新版本（V1 → V2 → V3）
2. 用户可以在不同版本间切换
3. 图片明确标记所属版本
4. 所有数据持久化存储在 Supabase
5. 提供版本对比能力

## 2. 功能需求

### 2.1 版本创建
- **触发时机**：
  - Session 创建时生成 V1（初始版本）
  - 用户点击"微调"按钮成功后生成新版本
  - 用户手动切换 Product State（FOLDED/UNFOLDED）并重新生成 Prompt 时创建新版本

- **版本命名规则**：
  - V1, V2, V3, ... (顺序递增)
  - 每个版本有独立的 UUID

### 2.2 版本切换
- **UI 交互**：
  - 在 Prompt 编辑区域上方显示版本选择器（下拉菜单）
  - 显示：版本号 + 创建时间 + Prompt 前 30 字符预览
  - 当前版本高亮显示

- **切换行为**：
  - 切换版本时，Prompt 编辑框内容更新
  - 对应的 Product State 和 Reference Image 也同步更新
  - 图片列表按所属版本筛选显示（可选：显示全部或仅当前版本）

### 2.3 版本标记
- **图片关联**：
  - 每张图片在生成时记录所属的 Prompt Version ID
  - 在图片卡片上显示版本标签（如 "V3"）
  - 可以根据版本号筛选图片

### 2.4 版本对比（未来扩展）
- 并排显示两个版本的 Prompt 差异
- 显示每个版本生成的图片统计数据

## 3. 数据持久化需求

- 所有 Prompt 版本存储在 Supabase 数据库
- Session 与 Prompt Version 是一对多关系
- Generated Image 与 Prompt Version 是多对一关系
- 删除 Session 时级联删除所有版本和图片

## 4. 用户交互流程

### 4.1 正常工作流
```
1. 用户完成 ABCD 选择 → 生成 Prompt → 创建 V1
2. 用户生成图片 → 图片标记为 V1
3. 用户微调 Prompt → 创建 V2
4. 用户继续生成图片 → 图片标记为 V2
5. 用户切换回 V1 → 查看 V1 的 Prompt 和图片
```

### 4.2 版本切换流程
```
1. 用户点击版本选择器
2. 看到所有版本列表（V1, V2, V3...）
3. 选择某个版本
4. Prompt 编辑框内容切换
5. 图片列表筛选显示该版本的图片（或标记显示）
```

## 5. 非功能需求

### 5.1 性能
- 版本切换响应时间 < 100ms
- 支持至少 20 个版本不影响性能

### 5.2 可靠性
- 所有版本数据持久化到 Supabase
- 支持浏览器刷新后恢复状态

### 5.3 用户体验
- 版本切换无感知（无需重新加载页面）
- 清晰的版本标识（版本号 + 时间戳）
- 图片上的版本标签清晰可见

## 6. 约束与假设

### 6.1 约束
- 使用现有的 Supabase 数据库
- 不影响现有的 Session 和 Image 功能
- 向后兼容：旧 Session 默认只有一个版本

### 6.2 假设
- 用户平均每个 Session 会创建 3-5 个版本
- 用户不需要删除单个版本（只能删除整个 Session）
- 版本创建是顺序的（不支持分支）

## 7. 成功指标

- 用户可以在不同版本间自由切换
- 每张图片都能追溯到生成它的 Prompt 版本
- 页面刷新后所有版本数据完整保留
- 版本选择器 UI 直观易用
